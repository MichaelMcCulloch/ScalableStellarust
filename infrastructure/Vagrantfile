Vagrant.configure("2") do |config|

    config.vm.box = "archlinux/archlinux"
    config.ssh.forward_agent = true
    config.vm.synced_folder ".", "/vagrant", disabled: true
  
    config.vm.provider "libvirt" do |lv|
      lv.memory = 8192
      lv.cpus = 32
      lv.nested = true
			lv.default_prefix = "stellarustCluster_"
      lv.disk_bus = "virtio"
      lv.disk_driver :cache => "writeback"
      lv.nic_model_type = "virtio"
      lv.storage :file, bus: "virtio", cache: "writeback"
      lv.driver = "kvm"
      lv.video_type = "virtio"

    end

    config.vm.network "private_network", 
      :dev => "virbr1", 
      :mode => "bridge", 
      :type => "dhcp", 
      :libvirt__domain_name => "datacenter.local",
      :libvirt__network_name => "datacenter.local",
      :libvirt__network_address => "172.28.128.0/24"

    define_datacenter config,3,7

    config.vm.provision "ansible" do |ansible|
      ansible.playbook = "config.yml"
    end

    config.vm.provision :reload
end

def define_datacenter(config, n_control_plane, n_worker)
  define_haproxy config
  define_k8s config,n_control_plane, n_worker
end

def define_haproxy(config)
  config.vm.define "haproxy" do |proxy|
    proxy.vm.hostname = "haproxy" 
    # proxy.vm.network "forwarded_port", guest: 6443, host: 6443 
  end
end

def define_k8s(config, n_control_plane, n_worker)
  define_control_plane config, n_control_plane
  define_worker_plane config, n_worker
end

def define_control_plane(config, n_control_plane)
  define_leader config
  (2..n_control_plane).each do |i|
    define_non_leader_control_plane config,i
  end
end

def define_leader(config)
  config.vm.define "master-01" do |node| 
    node.vm.hostname = "master-01" 
    node.vm.network "forwarded_port", guest: 8001, host: 8001
  end
end

def define_non_leader_control_plane(config, number)
  config.vm.define "master-#{number.to_s.rjust(2, "0")}"  do |node| 
    node.vm.hostname = "master-#{number.to_s.rjust(2, "0")}"
  end
end

def define_worker_plane(config, n_worker)
  (1..n_worker).each do |i| 
    define_worker config, i
  end
end

def define_worker(config, number) 
  config.vm.define "worker-#{number.to_s.rjust(2, "0")}"  do |node| 
    node.vm.hostname = "worker-#{number.to_s.rjust(2, "0")}"
  end 
end
