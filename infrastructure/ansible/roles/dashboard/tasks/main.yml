---
- name: intall helm-diff
  shell: helm plugin install https://github.com/databus23/helm-diff
  register: installDiffPlugin
  failed_when:
    - '"Installed plugin: diff" not in installDiffPlugin.stdout'
    - '"Error: plugin already exists" not in installDiffPlugin.stderr'

- name: Add a repository
  shell: helm repo add kubernetes-dashboard  https://kubernetes.github.io/dashboard/

- name: Install Kubernetes Dashboard
  register: installDashChart
  shell: >
    helm install --create-namespace \
      --namespace kubernetes-dashboard \
      kubernetes-dashboard kubernetes-dashboard/kubernetes-dashboard
  failed_when:
    - '"Error: INSTALLATION FAILED: cannot re-use a name that is still in use" not in installDashChart.stderr'
    - '"Get the Kubernetes Dashboard URL by running:" not in installDashChart.stdout'

- name: Install dashboard-adminuser.yml -> $HOME/dashboard-adminuser.yml
  register: svc_account
  copy:
    src: dashboard-adminuser.yml
    dest: $HOME/

- name: Apply dashboard-adminuser.yml
  when: svc_account.changed
  shell: kubectl apply -f $HOME/dashboard-adminuser.yml

- name: Install dashboard-cluster-rolebinding.yml -> $HOME/dashboard-cluster-rolebinding.yml
  register: cluster_role_binding
  copy:
    src: dashboard-cluster-rolebinding.yml
    dest: $HOME/

- name: Apply dashboard-cluster-rolebinding.yml
  when: cluster_role_binding.changed
  shell: kubectl apply -f $HOME/dashboard-cluster-rolebinding.yml
